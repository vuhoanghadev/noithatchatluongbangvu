<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hướng dẫn khắc phục lỗi Cloudinary</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }
        h1 {
            color: #f97316;
            border-bottom: 2px solid #f97316;
            padding-bottom: 10px;
        }
        h2 {
            color: #f97316;
            margin-top: 30px;
        }
        .solution {
            background-color: #f8f9fa;
            border-left: 4px solid #f97316;
            padding: 15px;
            margin: 20px 0;
        }
        code {
            background-color: #f1f1f1;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: Consolas, monospace;
        }
        pre {
            background-color: #f1f1f1;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .step {
            margin-bottom: 20px;
            padding-left: 20px;
            position: relative;
        }
        .step:before {
            content: "→";
            position: absolute;
            left: 0;
            color: #f97316;
        }
        img {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 10px 0;
        }
        .note {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
        }
        .success {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 20px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .btn {
            display: inline-block;
            background-color: #f97316;
            color: white;
            padding: 10px 15px;
            text-decoration: none;
            border-radius: 4px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>Hướng dẫn khắc phục lỗi hình ảnh Cloudinary</h1>
    
    <p>Khi triển khai trang web lên Vercel với tên miền mới, bạn có thể gặp vấn đề với việc hiển thị hình ảnh từ Cloudinary. Đây là hướng dẫn chi tiết để khắc phục vấn đề này.</p>
    
    <h2>Nguyên nhân phổ biến</h2>
    
    <div class="solution">
        <p>Có một số nguyên nhân phổ biến khiến hình ảnh từ Cloudinary không hiển thị:</p>
        <ol>
            <li><strong>Vấn đề CORS (Cross-Origin Resource Sharing)</strong>: Cloudinary chưa được cấu hình để cho phép tên miền mới của bạn truy cập hình ảnh.</li>
            <li><strong>Đường dẫn URL không chính xác</strong>: URL hình ảnh có thể không chính xác hoặc hình ảnh đã bị xóa.</li>
            <li><strong>Cấu hình Cloudinary</strong>: Tài khoản Cloudinary có thể có giới hạn về băng thông hoặc yêu cầu xác thực.</li>
            <li><strong>Vấn đề bảo mật</strong>: Vercel có thể đang áp dụng các chính sách bảo mật Content Security Policy (CSP) mặc định.</li>
        </ol>
    </div>
    
    <h2>Giải pháp 1: Cấu hình CORS trên Cloudinary</h2>
    
    <div class="step">
        <p><strong>Bước 1:</strong> Đăng nhập vào tài khoản Cloudinary của bạn tại <a href="https://cloudinary.com/console" target="_blank">https://cloudinary.com/console</a></p>
    </div>
    
    <div class="step">
        <p><strong>Bước 2:</strong> Vào phần Settings > Security</p>
    </div>
    
    <div class="step">
        <p><strong>Bước 3:</strong> Trong phần "Allowed origins", thêm tên miền mới của bạn:</p>
        <pre>https://your-domain.com</pre>
        <p>Nếu bạn muốn cho phép tất cả các tên miền, bạn có thể sử dụng dấu hoa thị:</p>
        <pre>*</pre>
        <p>Tuy nhiên, cách này không được khuyến khích vì lý do bảo mật.</p>
    </div>
    
    <div class="step">
        <p><strong>Bước 4:</strong> Lưu cấu hình và đợi một vài phút để thay đổi có hiệu lực</p>
    </div>
    
    <div class="note">
        <p><strong>Lưu ý:</strong> Nếu bạn đang sử dụng Cloudinary với tài khoản miễn phí, bạn có thể bị giới hạn về số lượng tên miền được phép trong cấu hình CORS.</p>
    </div>
    
    <h2>Giải pháp 2: Thêm thuộc tính crossorigin cho thẻ img</h2>
    
    <div class="solution">
        <p>Thêm thuộc tính <code>crossorigin="anonymous"</code> cho tất cả các thẻ img sử dụng Cloudinary:</p>
        <pre>&lt;img src="https://res.cloudinary.com/your-cloud-name/image/upload/your-image.jpg" 
     crossorigin="anonymous" 
     alt="Your image"&gt;</pre>
    </div>
    
    <p>Bạn có thể thêm thuộc tính này tự động bằng JavaScript. Tôi đã tạo file <code>js/cloudinary-fix.js</code> để giúp bạn làm điều này. Hãy thêm file này vào trang web của bạn:</p>
    
    <pre>&lt;script src="js/cloudinary-fix.js"&gt;&lt;/script&gt;</pre>
    
    <h2>Giải pháp 3: Sử dụng tham số chuyển đổi của Cloudinary</h2>
    
    <div class="solution">
        <p>Cloudinary cung cấp nhiều tham số chuyển đổi hình ảnh có thể giúp giải quyết vấn đề. Thử thêm các tham số sau vào URL:</p>
        
        <table>
            <tr>
                <th>Tham số</th>
                <th>Mô tả</th>
                <th>Ví dụ</th>
            </tr>
            <tr>
                <td><code>fl_lossy,q_auto</code></td>
                <td>Tối ưu hóa chất lượng hình ảnh</td>
                <td><code>https://res.cloudinary.com/your-cloud/image/upload/fl_lossy,q_auto/your-image.jpg</code></td>
            </tr>
            <tr>
                <td><code>f_auto</code></td>
                <td>Tự động chọn định dạng tốt nhất</td>
                <td><code>https://res.cloudinary.com/your-cloud/image/upload/f_auto/your-image.jpg</code></td>
            </tr>
            <tr>
                <td><code>w_auto</code></td>
                <td>Tự động điều chỉnh kích thước</td>
                <td><code>https://res.cloudinary.com/your-cloud/image/upload/w_auto/your-image.jpg</code></td>
            </tr>
        </table>
    </div>
    
    <h2>Giải pháp 4: Cấu hình Content Security Policy (CSP)</h2>
    
    <div class="solution">
        <p>Nếu bạn đang sử dụng CSP, hãy đảm bảo rằng bạn đã thêm domain của Cloudinary vào danh sách cho phép:</p>
        
        <pre>Content-Security-Policy: img-src 'self' res.cloudinary.com;</pre>
        
        <p>Với Vercel, bạn có thể cấu hình CSP bằng cách tạo file <code>vercel.json</code> trong thư mục gốc của dự án:</p>
        
        <pre>{
  "headers": [
    {
      "source": "/(.*)",
      "headers": [
        {
          "key": "Content-Security-Policy",
          "value": "default-src 'self'; img-src 'self' res.cloudinary.com data:; style-src 'self' 'unsafe-inline' fonts.googleapis.com; font-src 'self' fonts.gstatic.com; script-src 'self' 'unsafe-inline' 'unsafe-eval';"
        }
      ]
    }
  ]
}</pre>
    </div>
    
    <h2>Giải pháp 5: Sử dụng Cloudinary SDK</h2>
    
    <div class="solution">
        <p>Nếu bạn đang gặp nhiều vấn đề với URL trực tiếp, hãy cân nhắc sử dụng Cloudinary SDK để quản lý hình ảnh:</p>
        
        <pre>&lt;script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"&gt;&lt;/script&gt;

&lt;script type="text/javascript"&gt;
  const cloudinary = new Cloudinary({
    cloud_name: 'your-cloud-name',
    secure: true
  });
  
  // Sử dụng để tạo URL hình ảnh
  const imageUrl = cloudinary.url('your-image-id', {
    width: 300,
    crop: 'scale',
    secure: true
  });
  
  // Hoặc sử dụng để hiển thị hình ảnh
  cloudinary.imageTag('your-image-id', {
    width: 300,
    crop: 'scale'
  }).toHtml();
&lt;/script&gt;</pre>
    </div>
    
    <h2>Kiểm tra và gỡ lỗi</h2>
    
    <p>Tôi đã tạo một trang kiểm tra đơn giản để giúp bạn xác định vấn đề với hình ảnh Cloudinary:</p>
    
    <a href="cloudinary-test.html" class="btn">Mở trang kiểm tra Cloudinary</a>
    
    <div class="success">
        <p><strong>Mẹo:</strong> Mở Console trong Developer Tools của trình duyệt (F12) để xem các thông báo lỗi chi tiết khi tải hình ảnh.</p>
    </div>
    
    <h2>Tổng kết</h2>
    
    <p>Vấn đề hình ảnh Cloudinary không hiển thị thường liên quan đến cấu hình CORS. Hãy thực hiện các bước sau theo thứ tự:</p>
    
    <ol>
        <li>Cấu hình CORS trên Cloudinary để cho phép tên miền mới của bạn</li>
        <li>Thêm thuộc tính crossorigin="anonymous" cho các thẻ img</li>
        <li>Sử dụng tham số chuyển đổi của Cloudinary để tối ưu hóa hình ảnh</li>
        <li>Kiểm tra và cấu hình Content Security Policy nếu cần</li>
        <li>Cân nhắc sử dụng Cloudinary SDK cho các trường hợp phức tạp</li>
    </ol>
    
    <p>Nếu bạn vẫn gặp vấn đề sau khi thực hiện các bước trên, hãy kiểm tra Console trong Developer Tools của trình duyệt để xem thông báo lỗi chi tiết.</p>
</body>
</html>
